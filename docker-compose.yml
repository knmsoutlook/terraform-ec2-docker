version: "3.9"

services:
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    environment:
      SA_PASSWORD: "Password123!"
      ACCEPT_EULA: "Y"
    volumes:
      - dbdata:/var/opt/mssql
    networks:
      - appnet

  api:
    image: mcr.microsoft.com/dotnet/samples:dotnetapp
    container_name: dotnet_api
    ports:
      - "8082:80"
    environment:
      ConnectionStrings__Default: "Server=db;Database=mydb;User Id=sa;Password=Password123!"
    depends_on:
      - db
    networks:
      - appnet
    entrypoint:
      - /bin/sh
      - -c
      - |
        until /opt/mssql-tools/bin/sqlcmd -S db -U sa -P Password123! -Q "SELECT 1" > /dev/null 2>&1; do
          echo "Waiting for SQL Server..."
          sleep 5
        done
        dotnet myapp.dll

  web:
    image: nginx:alpine
    container_name: web_ui
    ports:
      - "8088:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./index.html:/usr/share/nginx/html/index.html:ro
    depends_on:
      - api
    networks:
      - appnet

volumes:
  dbdata:

networks:
  appnet: